# `api_utilities.f90`

**Note:** The Fortran module name is `api_utilites` (with a typo), but the file is typically named `api_utilities.f90`.

## Overview

The `api_utilites` module provides utility subroutines intended for use with the public API of the GX-TimeFrequency library. These utilities help in validating input parameters and retrieving error messages generated by the library.

## Key Components

### Public Subroutines:

- **`gx_check_ntau(ntau, msg, ierr)`**:
    - **Purpose**: Checks if the provided number of imaginary time points (`ntau`) is a supported value within the library.
    - **Inputs**:
        - `ntau`: Integer, the number of imaginary time points to check.
    - **Outputs**:
        - `msg`: Character string, an informational or error message.
        - `ierr`: Integer, an error status.
            - `0`: `ntau` is found in the internal list of supported sizes.
            - `1` (or non-zero): `ntau` is not supported, or an internal inconsistency was detected.
    - **Logic**:
        1. It first checks for internal consistency:
            - If the size of `omega_npoints_supported` (from `minimax_omega`) is different from `tau_npoints_supported` (from `minimax_tau`).
            - If any corresponding elements in `omega_npoints_supported` and `tau_npoints_supported` are different.
            If either is true, an internal inconsistency message is set.
        2. It then iterates through the `tau_npoints_supported` array. If `ntau` matches a value in this list, `ierr` is set to `0`, `msg` is updated to indicate success, and the subroutine exits.
        3. If `ntau` is not found after checking all supported values, `ierr` remains non-zero (or is set to 1), and `msg` is populated with a formatted error message listing the available supported `ntau` values.

- **`gx_get_error_message(msg)`**:
    - **Purpose**: Retrieves the most recent error message logged by the GreenX library's error handling system.
    - **Outputs**:
        - `msg`: Character string, filled with the error message. The length of the copied message is limited by the length of the `msg` argument provided by the caller.
    - **Logic**:
        - It accesses an internal character variable `error_message__` (presumably from the `error_handling` module) and copies its content to the output `msg` string. It ensures that it does not write beyond the allocated length of `msg`.
    - **Usage**: This subroutine should be called by users of the GreenX API if an API function returns a non-zero `ierr` status, to get a human-readable error description.

## Important Variables/Constants

(None defined directly in this module, only imported ones used.)

## Usage Examples

```fortran
program test_api_utils
  use api_utilites
  implicit none

  integer :: ntau_val, err_status
  character(len=256) :: message

  ! Example 1: Check a supported ntau
  ntau_val = 16
  call gx_check_ntau(ntau_val, message, err_status)
  if (err_status == 0) then
    print *, "Check for ntau = ", ntau_val, ": OK. Message: ", trim(message)
  else
    print *, "Check for ntau = ", ntau_val, ": FAILED. Error: ", trim(message)
  end if

  ! Example 2: Check an unsupported ntau
  ntau_val = 17
  call gx_check_ntau(ntau_val, message, err_status)
  if (err_status == 0) then
    print *, "Check for ntau = ", ntau_val, ": OK. Message: ", trim(message)
  else
    print *, "Check for ntau = ", ntau_val, ": FAILED. Error: ", trim(message)
    ! If an error occurred in some other gx_routine, retrieve it
    ! call gx_some_api_routine(..., ierr=err_status_api)
    ! if (err_status_api /= 0) then
    !   call gx_get_error_message(message)
    !   print *, "API Error: ", trim(message)
    ! end if
  end if

  ! Example 3: Retrieving a generic error message (illustrative)
  ! (Assuming an error was set in error_message__ by another routine)
  ! call gx_get_error_message(message)
  ! print *, "Last library error: ", trim(message)

end program test_api_utils
```

## Dependencies and Interactions

- **`error_handling`**: This module is used to access the global error message string `error_message__`. The `gx_get_error_message` subroutine directly relies on this.
- **`minimax_omega`**: Imports `omega_npoints_supported` for consistency checks in `gx_check_ntau`.
- **`minimax_tau`**: Imports `tau_npoints_supported` which provides the list of valid `ntau` values checked against in `gx_check_ntau`.

This module serves as a simple interface for common API-related tasks like input validation and standardized error message retrieval, promoting ease of use and debugging for end-users of the library.
