# `m_paw_io.F90`

## Overview

The Fortran module `m_paw_io` provides specialized input/output routines tailored for Projector Augmented Wave (PAW) related data. Currently, its primary public interface is the `pawio_print_ij` subroutine, which is designed to print square matrices (like \(D_{ij}\) or \(\rho_{ij}\) PAW matrices) in a human-readable and configurable format. This routine handles complexities such as complex numbers, packed storage, symmetry considerations, and unit conversions.

## Key Components

### Public Subroutines

-   **`pawio_print_ij(unit, a_ij, adim, cplex, ndim, opt_l, opt_l_index, opt_pack, opt_prtvol, pack2ij, test_value, Ha_or_eV, mode_paral, opt_sym, asym_ij)`**:
    -   **Purpose**: Prints a square matrix `a_ij` (typically representing PAW \(D_{ij}\) or \(\rho_{ij}\) elements) to a specified Fortran unit.
    -   **Inputs**:
        -   `unit`: Integer, Fortran unit number for output.
        -   `a_ij(cplex*adim)`: `real(dp)`, the input matrix data.
        -   `adim`: Integer, dimension of `a_ij`. Depends on `opt_pack`.
            -   If `opt_pack=0`: `adim = ndim*(ndim+1)/2` (lower or upper triangle stored).
            -   If `opt_pack=1`: `adim` is the number of non-zero values (packed storage).
        -   `cplex`: Integer, 1 if `a_ij` is real, 2 if complex (real and imaginary parts interleaved).
        -   `ndim`: Integer, the actual dimension of the square matrix.
        -   `opt_l`: Integer (optional). If \(\ge 0\), only prints elements where both row and column indices correspond to this angular momentum \(l\). If \(<0\), prints all.
        -   `opt_l_index(ndim)`: Integer array (optional), maps matrix index to \(l\) quantum number. Used if `opt_l >= 0`.
        -   `opt_pack`: Integer:
            -   `0`: `a_ij` stores \(A(j(j-1)/2+i)\) for \(i \le j\).
            -   `+1`: `a_ij` is in packed storage (only non-zero values), `pack2ij` maps packed index to full matrix \( (i,j) \) index.
        -   `opt_prtvol`: Integer (optional), verbosity/print volume. If \(\ge 0\), prints up to `maxprt_default` (currently 12) components. If \(<0\), prints all `nmin` components.
        -   `pack2ij(adim)`: Integer array (optional), used if `opt_pack=1` to map packed index to \(j(j-1)/2+i\).
        -   `test_value`: `real(dp)`, if positive, prints a warning if any matrix element's magnitude exceeds this value.
        -   `Ha_or_eV`: Integer, 1 for output in Hartrees (default), 2 for output in Electronvolts.
        -   `mode_paral`: Character string (optional, default `'COLL'`). Controls MPI parallel output behavior (see `m_libpaw_tools`).
        -   `opt_sym`: Integer (optional, default `2`). Defines symmetry for reconstructing the full matrix from triangular part:
            -   `1`: \(A(j,i) = A(i,j)\) (symmetric real/complex)
            -   `2`: \(A(j,i) = \text{conj}(A(i,j))\) (Hermitian)
            -   `3`: \(A(j,i) = -A(i,j)\) (anti-symmetric real/complex)
            -   `4`: \(A(j,i) = -\text{conj}(A(i,j))\) (anti-Hermitian)
        -   `asym_ij(cplex*adim)`: `real(dp)` (optional). If present, the \(A(j,i)\) (upper triangle) elements are taken from `asym_ij` instead of being generated by symmetry from `a_ij` (lower triangle).
    -   **Logic**:
        1.  Handles optional arguments and sets defaults.
        2.  Determines `maxprt` (maximum components to print per line) based on `opt_prtvol`.
        3.  Unpacks `a_ij` (and `asym_ij` if present) from potentially packed storage into a temporary full lower-triangular matrix `b_ij` (and `bsym_ij`).
        4.  Transfers the lower triangular part `b_ij` to a temporary square matrix `prtab`.
        5.  Fills the upper triangular part of `prtab` based on `bsym_ij` (if `use_asym` is true) or by applying the symmetry specified by `optsym` to `b_ij`.
        6.  If `Ha_or_eV == 2`, converts `prtab` (and `tabmax`/`tabmin` if calculated) from Hartrees to eV.
        7.  Prints the real part of `prtab`. If `cplex == 2`, then prints the imaginary part.
        8.  Printing is formatted: up to `maxprt` elements per line. If matrix size exceeds `maxprt` (and `opt_prtvol >=0`), it indicates that only partial components are shown.
        9.  If `opt_prtvol < 0` and `opt_l < 0`, prints max/min absolute values.
        10. If `test_value > 0`, checks if any element magnitude exceeds `test_value` and prints a warning if so.
        11. Deallocates temporary arrays.

## Important Variables/Constants

-   `maxprt_default`: Integer parameter, default `12`, controls how many matrix elements are printed per line if `opt_prtvol >= 0`.
-   `fact_re`, `fact_im`: Small parameter arrays used to apply symmetry operations for complex numbers correctly.

## Usage Examples

```fortran
module m_example_paw_io_usage
    use m_libpaw_defs, only: dp, std_out
    use m_paw_io
    implicit none

    subroutine print_dij_matrix(dij_elements, matrix_dim, is_complex, l_indices)
        ! dij_elements stores the lower triangle in column-major order: D11, D21, D22, D31, D32, D33 ...
        real(dp), intent(in) :: dij_elements(:) ! size cplex_val * matrix_dim * (matrix_dim+1)/2
        integer, intent(in) :: matrix_dim
        integer, intent(in) :: is_complex ! 1 for real, 2 for complex
        integer, intent(in) :: l_indices(matrix_dim) ! l value for each row/column

        integer :: storage_dim

        storage_dim = matrix_dim * (matrix_dim + 1) / 2

        call pawio_print_ij(unit=std_out, a_ij=dij_elements, &
                            adim=storage_dim, cplex=is_complex, ndim=matrix_dim, &
                            opt_l=-1, opt_l_index=l_indices, & ! Print all l, provide l_indices for context if needed
                            opt_pack=0, opt_prtvol=-1, & ! opt_pack=0 assumes triangular storage
                            test_value=10.0_dp, Ha_or_eV=1, & ! Warn if elements > 10 Ha, print in Ha
                            mode_paral="COLL", opt_sym=2)     ! Hermitian symmetry by default

    end subroutine print_dij_matrix

end module m_example_paw_io_usage
```
This example shows a call to `pawio_print_ij` to print a PAW matrix. The actual `dij_elements` would be populated by other `libPAW` routines.

## Dependencies and Interactions

-   **`m_libpaw_defs` (`USE_DEFS`)**: For `dp`, `std_out`, `one`, `zero`, `Ha_eV`.
-   **`m_libpaw_tools` (`USE_MSG_HANDLING`)**: For `wrtout` for parallel-aware printing.
-   **`m_libpaw_memory` (`USE_MEMORY_PROFILING`)**: For memory allocation macros (`LIBPAW_ALLOCATE`, `LIBPAW_DEALLOCATE`).
-   This module is primarily a utility for inspecting and debugging PAW-related matrices by providing formatted output. It would be used by higher-level routines that compute or manage these matrices.

The `pawio_print_ij` subroutine is quite flexible due to its numerous optional arguments, allowing for tailored output of complex matrix structures commonly found in PAW calculations.
